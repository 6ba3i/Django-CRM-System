<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - CRM Pro</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
    <div class="login-container">
        <div class="logo">CRM Pro</div>
        <p class="tagline">Professional Customer Relationship Management</p>
        
        <h1>Welcome Back</h1>
        
        {% if form.errors %}
        <div class="status-message status-error">
            <strong>Login Error:</strong><br>
            {% for field, errors in form.errors.items %}
                {% for error in errors %}
                    {{ error }}<br>
                {% endfor %}
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Email/Password Login Form -->
        <form method="post">
            {% csrf_token %}
            <div style="display: grid; gap: 16px;">
                <div>
                    <input type="email" name="login" placeholder="Email address" class="glass-input" required 
                           value="{{ form.login.value|default:'' }}">
                </div>
                
                <div>
                    <input type="password" name="password" placeholder="Password" class="glass-input" required>
                </div>
                
                <button type="submit" class="init-btn">
                    Sign In
                </button>
            </div>
        </form>
        
        <div style="text-align: center; margin-top: 24px;">
            <a href="{% url 'account_signup' %}" class="demo-login">
                Don't have an account? Sign Up
            </a>
        </div>
        
        <!-- Demo Account Info -->
        <div class="initialization-panel">
            <div class="init-title">Demo Account</div>
            <div class="init-description">
                Try the system with the default admin account:
            </div>
            <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; margin: 16px 0; font-family: monospace;">
                <div><strong>Email:</strong> admin@crm.local</div>
                <div><strong>Password:</strong> admin123</div>
            </div>
            
            <button class="init-btn" onclick="initializeSystem()" id="initBtn">
                Initialize System First
            </button>
            
            <div id="statusMessage"></div>
            
            <div class="features">
                <ul class="feature-list">
                    <li>Firebase cloud database</li>
                    <li>Sample customers & deals</li>
                    <li>Analytics dashboard</li>
                    <li>Admin panel access</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        async function initializeSystem() {
            const btn = document.getElementById('initBtn');
            const statusDiv = document.getElementById('statusMessage');
            
            btn.disabled = true;
            btn.textContent = 'Initializing...';
            
            statusDiv.className = 'status-message status-loading';
            statusDiv.textContent = 'Setting up your CRM system...';
            
            try {
                const response = await fetch('/api/init/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken'),
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.className = 'status-message status-success';
                    statusDiv.innerHTML = `
                        <strong>✅ Success!</strong><br>
                        ${data.message}<br>
                        Firebase: ${data.firebase_enabled ? 'Connected' : 'Disabled'}<br>
                        <small>You can now login with admin@crm.local / admin123</small>
                    `;
                    btn.textContent = '✓ Initialized';
                } else {
                    throw new Error(data.error || 'Initialization failed');
                }
            } catch (error) {
                statusDiv.className = 'status-message status-error';
                statusDiv.innerHTML = `
                    <strong>❌ Error:</strong><br>
                    ${error.message}<br>
                    <small>Please check your Firebase configuration</small>
                `;
                btn.disabled = false;
                btn.textContent = 'Retry Initialization';
            }
        }
    </script>
</body>
</html>